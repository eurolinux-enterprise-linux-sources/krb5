From d9bf04cb289f59580640363937ba15d99d8e6aa9 Mon Sep 17 00:00:00 2001
From: Mark Shields <mshields@twitter.com>
Date: Thu, 28 Apr 2016 10:36:47 -0400
Subject: [PATCH 1/2] Backport dns_canonicalize_hostname support

---
 src/include/k5-int.h        | 2 ++
 src/lib/krb5/krb/init_ctx.c | 8 ++++++++
 src/lib/krb5/os/sn2princ.c  | 2 +-
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/include/k5-int.h b/src/include/k5-int.h
index 745b6a3..b4d3281 100644
--- a/src/include/k5-int.h
+++ b/src/include/k5-int.h
@@ -208,6 +208,7 @@ typedef INT64_TYPE krb5_int64;
 #define KRB5_CONF_DISABLE                     "disable"
 #define KRB5_CONF_DISABLE_LAST_SUCCESS        "disable_last_success"
 #define KRB5_CONF_DISABLE_LOCKOUT             "disable_lockout"
+#define KRB5_CONF_DNS_CANONICALIZE_HOSTNAME   "dns_canonicalize_hostname"
 #define KRB5_CONF_DNS_LOOKUP_KDC              "dns_lookup_kdc"
 #define KRB5_CONF_DNS_LOOKUP_REALM            "dns_lookup_realm"
 #define KRB5_CONF_DNS_FALLBACK                "dns_fallback"
@@ -1489,6 +1490,7 @@ struct _krb5_context {
 
     krb5_boolean allow_weak_crypto;
     krb5_boolean ignore_acceptor_hostname;
+    krb5_boolean dns_canonicalize_hostname;
 
     krb5_trace_callback trace_callback;
     void *trace_callback_data;
diff --git a/src/lib/krb5/krb/init_ctx.c b/src/lib/krb5/krb/init_ctx.c
index 499f9f0..cd0f86b 100644
--- a/src/lib/krb5/krb/init_ctx.c
+++ b/src/lib/krb5/krb/init_ctx.c
@@ -179,6 +179,14 @@ krb5_init_context_profile(profile_t profile, krb5_flags flags,
         goto cleanup;
     ctx->ignore_acceptor_hostname = tmp;
 
+    /* Disables canonicalizing hostnames for service principals. */
+    retval = profile_get_boolean(ctx->profile, KRB5_CONF_LIBDEFAULTS,
+				 KRB5_CONF_DNS_CANONICALIZE_HOSTNAME, NULL, 1,
+				 &tmp);
+    if (retval)
+     	goto cleanup;
+    ctx->dns_canonicalize_hostname = tmp;
+
     /* initialize the prng (not well, but passable) */
     if ((retval = krb5_c_random_os_entropy( ctx, 0, NULL)) !=0)
         goto cleanup;
diff --git a/src/lib/krb5/os/sn2princ.c b/src/lib/krb5/os/sn2princ.c
index f149feb..2a42445 100644
--- a/src/lib/krb5/os/sn2princ.c
+++ b/src/lib/krb5/os/sn2princ.c
@@ -89,7 +89,7 @@ krb5_sname_to_principal(krb5_context context, const char *hostname, const char *
 
         /* copy the hostname into non-volatile storage */
 
-        if (type == KRB5_NT_SRV_HST) {
+        if (type == KRB5_NT_SRV_HST && context->dns_canonicalize_hostname) {
             struct addrinfo *ai = NULL, hints;
             int err;
             char hnamebuf[NI_MAXHOST];
-- 
2.9.3

