From 69e057b39dc22114a8e1eaa3ce2e22a992b28b82 Mon Sep 17 00:00:00 2001
From: Greg Hudson <ghudson@mit.edu>
Date: Sun, 4 Oct 2015 14:45:29 -0400
Subject: [PATCH 2/3] Use RUN_TEST and fix installed krb5.conf uses

Use $(RUN_TEST) to run most C test programs, for simplicity and to fix
accidental uses of the installed krb5.conf.  Where a particular
krb5.conf must be used instead of the one in src/config-files, use a
locally defined variant like RUN_TEST_LOCAL_CONF.

Accidental references to the installed krb5.conf were present when
running t_pac, t_princ, t_etypes, t_trace, t_attr, t_attrset,
t_packet, t_remote, t_client, pkinit_kdf_test, test_chpw_message,
text_cxx_krb5, and test_cxx_k5int.

Based on a patch from Robbie Harwood.

ticket: 8266
target_version: 1.14
tags: pullup

(cherry-picked from commit 4eea9c287e43ab40936e25094cd093f2f3f32bd9)
[rharwood@redhat.com: not clean]
---
 src/kdc/Makefile.in                     |  3 +--
 src/lib/crypto/builtin/des/Makefile.in  |  8 +++---
 src/lib/crypto/builtin/sha1/Makefile.in |  4 +--
 src/lib/crypto/builtin/sha2/Makefile.in |  2 +-
 src/lib/crypto/crypto_tests/Makefile.in | 46 ++++++++++++++++-----------------
 src/lib/crypto/krb/Makefile.in          |  2 +-
 src/lib/krb5/ccache/Makefile.in         |  2 +-
 src/lib/krb5/keytab/Makefile.in         |  3 +--
 src/lib/krb5/krb/Makefile.in            | 26 +++++++++----------
 src/lib/krb5/os/Makefile.in             | 10 ++++---
 src/plugins/preauth/pkinit/Makefile.in  |  2 +-
 src/tests/asn.1/Makefile.in             | 16 +++---------
 src/tests/gssapi/Makefile.in            |  2 +-
 src/tests/misc/Makefile.in              | 12 ++++-----
 src/tests/resolve/Makefile.in           |  6 ++---
 src/tests/shlib/Makefile.in             |  2 +-
 src/tests/threads/Makefile.in           |  2 +-
 src/util/et/Makefile.in                 |  4 +--
 src/util/profile/Makefile.in            |  6 ++---
 19 files changed, 75 insertions(+), 83 deletions(-)

diff --git a/src/kdc/Makefile.in b/src/kdc/Makefile.in
index 8994a6a..76b2334 100644
--- a/src/kdc/Makefile.in
+++ b/src/kdc/Makefile.in
@@ -64,8 +64,7 @@ rtest: $(RT_OBJS) $(KDB5_DEPLIBS) $(KADM_COMM_DEPLIBS) $(KRB5_BASE_DEPLIBS)
 	$(CC_LINK) -o rtest $(RT_OBJS) $(KDB5_LIBS) $(KADM_COMM_LIBS) $(KRB5_BASE_LIBS)
 
 check-unix:: rtest
-	KRB5_CONFIG=$(top_srcdir)/config-files/krb5.conf ; export KRB5_CONFIG ; \
-	$(RUN_SETUP) $(VALGRIND) $(srcdir)/rtscript > test.out
+	$(RUN_TEST) $(srcdir)/rtscript > test.out
 	cmp test.out $(srcdir)/rtest.good
 	$(RM) test.out
 
diff --git a/src/lib/crypto/builtin/des/Makefile.in b/src/lib/crypto/builtin/des/Makefile.in
index 6a17b36..2a651e9 100644
--- a/src/lib/crypto/builtin/des/Makefile.in
+++ b/src/lib/crypto/builtin/des/Makefile.in
@@ -65,10 +65,10 @@ destest$(EXEEXT): destest.$(OBJEXT) $(TOBJS) $(SUPPORT_DEPLIB)
 all-unix:: all-libobjs
 
 check-unix:: verify destest
-	$(RUN_SETUP) $(VALGRIND) ./verify -z
-	$(RUN_SETUP) $(VALGRIND) ./verify -m
-	$(RUN_SETUP) $(VALGRIND) ./verify
-	$(RUN_SETUP) $(VALGRIND) ./destest < $(srcdir)/keytest.data
+	$(RUN_TEST) ./verify -z
+	$(RUN_TEST) ./verify -m
+	$(RUN_TEST) ./verify
+	$(RUN_TEST) ./destest < $(srcdir)/keytest.data
 
 includes:: depend
 
diff --git a/src/lib/crypto/builtin/sha1/Makefile.in b/src/lib/crypto/builtin/sha1/Makefile.in
index 00e6cb6..292b8ff 100644
--- a/src/lib/crypto/builtin/sha1/Makefile.in
+++ b/src/lib/crypto/builtin/sha1/Makefile.in
@@ -33,8 +33,8 @@ t_shs3: t_shs3.o shs.o $(SUPPORT_DEPLIB)
 	$(CC_LINK) -o t_shs3 t_shs3.o shs.o $(SUPPORT_LIB)
 
 check-unix:: t_shs t_shs3
-	$(RUN_SETUP) $(VALGRIND) $(C)t_shs -x
-	$(RUN_SETUP) $(VALGRIND) $(C)t_shs3
+	$(RUN_TEST) $(C)t_shs -x
+	$(RUN_TEST) $(C)t_shs3
 
 check-windows:: $(OUTPRE)t_shs.exe $(OUTPRE)t_shs3.exe
 	$(OUTPRE)$(C)t_shs.exe -x
diff --git a/src/lib/crypto/builtin/sha2/Makefile.in b/src/lib/crypto/builtin/sha2/Makefile.in
index ffb9b74..7154ede 100644
--- a/src/lib/crypto/builtin/sha2/Makefile.in
+++ b/src/lib/crypto/builtin/sha2/Makefile.in
@@ -33,7 +33,7 @@ $(OUTPRE)t_sha256.exe: $(OUTPRE)t_sha256.obj $(OUTPRE)sha256.obj
 
 
 check-unix:: t_sha256
-	$(RUN_SETUP) $(VALGRIND) $(C)t_sha256
+	$(RUN_TEST) $(C)t_sha256
 
 clean::
 	$(RM) t_sha256$(EXEEXT) t_sha256.$(OBJEXT)
diff --git a/src/lib/crypto/crypto_tests/Makefile.in b/src/lib/crypto/crypto_tests/Makefile.in
index 5aeef54..a6039ca 100644
--- a/src/lib/crypto/crypto_tests/Makefile.in
+++ b/src/lib/crypto/crypto_tests/Makefile.in
@@ -41,35 +41,35 @@ check-unix:: t_nfold t_encrypt t_decrypt t_prf t_prng t_cmac t_hmac \
 		camellia-test  \
 		t_mddriver4 t_mddriver \
 		t_crc t_cts t_short t_str2key t_derive t_fork t_cf2
-	$(RUN_SETUP) $(VALGRIND) ./t_nfold
-	$(RUN_SETUP) $(VALGRIND) ./t_encrypt
-	$(RUN_SETUP) $(VALGRIND) ./t_decrypt
-	$(RUN_SETUP) $(VALGRIND) ./t_prng <$(srcdir)/t_prng.seed >t_prng.output
-	$(RUN_SETUP) $(VALGRIND) ./t_cmac
-	$(RUN_SETUP) $(VALGRIND) ./t_hmac
-	$(RUN_SETUP) $(VALGRIND) ./t_prf <$(srcdir)/t_prf.in >t_prf.output
+	$(RUN_TEST) ./t_nfold
+	$(RUN_TEST) ./t_encrypt
+	$(RUN_TEST) ./t_decrypt
+	$(RUN_TEST) ./t_prng <$(srcdir)/t_prng.seed >t_prng.output
+	$(RUN_TEST) ./t_cmac
+	$(RUN_TEST) ./t_hmac
+	$(RUN_TEST) ./t_prf <$(srcdir)/t_prf.in >t_prf.output
 	diff t_prf.output $(srcdir)/t_prf.expected
-	$(RUN_SETUP) $(VALGRIND) ./t_cksum4 "this is a test" e3f76a07f3401e3536b43a3f54226c39422c35682c354835
-	$(RUN_SETUP) $(VALGRIND) ./t_cksum5 "this is a test" e3f76a07f3401e351143ee6f4c09be1edb4264d55015db53
-	$(RUN_SETUP) $(VALGRIND) ./t_cksums
-	$(RUN_SETUP) $(VALGRIND) ./t_crc
-	$(RUN_SETUP) $(VALGRIND) ./t_cts
-	$(RUN_SETUP) $(VALGRIND) ./aes-test -k > vk.txt
+	$(RUN_TEST) ./t_cksum4 "this is a test" e3f76a07f3401e3536b43a3f54226c39422c35682c354835
+	$(RUN_TEST) ./t_cksum5 "this is a test" e3f76a07f3401e351143ee6f4c09be1edb4264d55015db53
+	$(RUN_TEST) ./t_cksums
+	$(RUN_TEST) ./t_crc
+	$(RUN_TEST) ./t_cts
+	$(RUN_TEST) ./aes-test -k > vk.txt
 	cmp vk.txt $(srcdir)/expect-vk.txt
-	$(RUN_SETUP) $(VALGRIND) ./aes-test > vt.txt
+	$(RUN_TEST) ./aes-test > vt.txt
 	cmp vt.txt $(srcdir)/expect-vt.txt
-	$(RUN_SETUP) $(VALGRIND) ./camellia-test > camellia-vt.txt
+	$(RUN_TEST) ./camellia-test > camellia-vt.txt
 # Enable this when Camellia becomes unconditional.
 #	cmp camellia-vt.txt $(srcdir)/camellia-expect-vt.txt
-	$(RUN_SETUP) $(VALGRIND) $(C)t_mddriver4 -x
-	$(RUN_SETUP) $(VALGRIND) $(C)t_mddriver -x
-	$(RUN_SETUP) $(VALGRIND) ./t_short
-	$(RUN_SETUP) $(VALGRIND) ./t_str2key
-	$(RUN_SETUP) $(VALGRIND) ./t_derive
-	$(RUN_SETUP) $(VALGRIND) ./t_fork
-	$(RUN_SETUP) $(VALGRIND) ./t_cf2 <$(srcdir)/t_cf2.in >t_cf2.output
+	$(RUN_TEST) $(C)t_mddriver4 -x
+	$(RUN_TEST) $(C)t_mddriver -x
+	$(RUN_TEST) ./t_short
+	$(RUN_TEST) ./t_str2key
+	$(RUN_TEST) ./t_derive
+	$(RUN_TEST) ./t_fork
+	$(RUN_TEST) ./t_cf2 <$(srcdir)/t_cf2.in >t_cf2.output
 	diff t_cf2.output $(srcdir)/t_cf2.expected
-#	$(RUN_SETUP) $(VALGRIND) ./t_pkcs5
+#	$(RUN_TEST) ./t_pkcs5
 
 t_nfold$(EXEEXT): t_nfold.$(OBJEXT) $(KRB5_BASE_DEPLIBS)
 	$(CC_LINK) -o $@ t_nfold.$(OBJEXT) $(KRB5_BASE_LIBS)
diff --git a/src/lib/crypto/krb/Makefile.in b/src/lib/crypto/krb/Makefile.in
index b65559b..facfdc4 100644
--- a/src/lib/crypto/krb/Makefile.in
+++ b/src/lib/crypto/krb/Makefile.in
@@ -208,7 +208,7 @@ depend:: $(SRCS)
 
 check-unix:: t_fortuna
 	if [ $(PRNG_ALG) = fortuna ]; then \
-		$(RUN_SETUP) $(VALGRIND) ./t_fortuna > t_fortuna.output; \
+		$(RUN_TEST) ./t_fortuna > t_fortuna.output; \
 		cmp t_fortuna.output $(srcdir)/t_fortuna.expected; \
 	fi
 
diff --git a/src/lib/krb5/ccache/Makefile.in b/src/lib/krb5/ccache/Makefile.in
index f64226b..fb9ddc1 100644
--- a/src/lib/krb5/ccache/Makefile.in
+++ b/src/lib/krb5/ccache/Makefile.in
@@ -114,7 +114,7 @@ t_cccursor: $(T_CCCURSOR_OBJS) $(KRB5_BASE_DEPLIBS)
 
 check-unix:: t_cc
 	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
-	$(RUN_SETUP) $(VALGRIND) ./t_cc
+	$(RUN_TEST) ./t_cc
 
 check-pytests:: t_cccursor
 	$(RUNPYTEST) $(srcdir)/t_cccol.py $(PYTESTFLAGS)
diff --git a/src/lib/krb5/keytab/Makefile.in b/src/lib/krb5/keytab/Makefile.in
index e4583a1..41430d9 100644
--- a/src/lib/krb5/keytab/Makefile.in
+++ b/src/lib/krb5/keytab/Makefile.in
@@ -62,8 +62,7 @@ all-unix:: all-libobjs
 clean-unix:: clean-libobjs
 
 check-unix:: t_keytab
-	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
-	$(RUN_SETUP) $(VALGRIND) ./t_keytab
+	$(RUN_TEST) ./t_keytab
 
 T_KEYTAB_OBJS = t_keytab.o
 t_keytab: $(T_KEYTAB_OBJS) $(KRB5_BASE_DEPLIBS)
diff --git a/src/lib/krb5/krb/Makefile.in b/src/lib/krb5/krb/Makefile.in
index 6c152c8..4e7dbee 100644
--- a/src/lib/krb5/krb/Makefile.in
+++ b/src/lib/krb5/krb/Makefile.in
@@ -6,6 +6,10 @@ PROG_RPATH=$(KRB5_LIBDIR)
 LOCALINCLUDES = -I$(srcdir)/../os -I$(top_srcdir)
 DEFS=-DLIBDIR=\"$(KRB5_LIBDIR)\" -DDYNOBJEXT=\"$(DYNOBJEXT)\"
 
+# Like RUN_TEST, but use t_krb5.conf from this directory.
+RUN_TEST_LOCAL_CONF=$(RUN_SETUP) KRB5_CONFIG=$(srcdir)/t_krb5.conf LC_ALL=C \
+	$(VALGRIND)
+
 ##DOS##BUILDTOP = ..\..\..
 ##DOS##PREFIXDIR=krb
 ##DOS##OBJFILE=..\$(OUTPRE)$(PREFIXDIR).lst
@@ -415,8 +419,7 @@ TEST_PROGS= t_walk_rtree t_kerb t_ser t_deltat t_expand t_authdata t_pac \
 	t_princ t_etypes t_vfy_increds t_sname_match
 
 check-unix:: $(TEST_PROGS)
-	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
-	$(RUN_SETUP) $(VALGRIND) ./t_kerb \
+	$(RUN_TEST_LOCAL_CONF) ./t_kerb \
 		parse_name tytso \
 		parse_name tytso@SHAZAAM \
 		parse_name tytso/root@VEGGIE.COM \
@@ -439,17 +442,14 @@ check-unix:: $(TEST_PROGS)
 		> test.out
 	cmp test.out $(srcdir)/t_ref_kerb.out
 	$(RM) test.out
-	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
-		$(RUN_SETUP) $(VALGRIND) ./t_ser
-	$(RUN_SETUP) $(VALGRIND) ./t_deltat
-	$(RUN_SETUP) $(VALGRIND) sh $(srcdir)/transit-tests
-	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
-		$(RUN_SETUP) $(VALGRIND) sh $(srcdir)/walktree-tests
-	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
-	$(RUN_SETUP) $(VALGRIND) ./t_authdata
-	$(RUN_SETUP) $(VALGRIND) ./t_pac
-	$(RUN_SETUP) $(VALGRIND) ./t_princ
-	$(RUN_SETUP) $(VALGRIND) ./t_etypes
+	$(RUN_TEST) ./t_ser
+	$(RUN_TEST) ./t_deltat
+	$(RUN_TEST) sh $(srcdir)/transit-tests
+	$(RUN_TEST_LOCAL_CONF) sh $(srcdir)/walktree-tests
+	$(RUN_TEST) ./t_authdata
+	$(RUN_TEST) ./t_pac
+	$(RUN_TEST) ./t_princ
+	$(RUN_TEST) ./t_etypes
 	$(RUN_TEST) ./t_sname_match
 
 check-pytests:: t_expire_warn t_vfy_increds
diff --git a/src/lib/krb5/os/Makefile.in b/src/lib/krb5/os/Makefile.in
index 6a37032..ec1d253 100644
--- a/src/lib/krb5/os/Makefile.in
+++ b/src/lib/krb5/os/Makefile.in
@@ -7,6 +7,10 @@ DEFS=
 DEFINES=-DLIBDIR=\"$(KRB5_LIBDIR)\"
 LOCALINCLUDES=-I$(top_srcdir)/util/profile
 
+# Like RUN_TEST, but use td_krb5.conf from this directory.
+RUN_TEST_LOCAL_CONF=$(RUN_SETUP) KRB5_CONFIG=$(srcdir)/td_krb5.conf LC_ALL=C \
+	$(VALGRIND)
+
 ##DOS##BUILDTOP = ..\..\..
 ##DOS##PREFIXDIR=os
 ##DOS##OBJFILE=..\$(OUTPRE)$(PREFIXDIR).lst
@@ -202,8 +206,7 @@ lclint-localaddr: localaddr.c
 check-unix:: check-unix-stdconf check-unix-locate
 
 check-unix-stdconf:: t_std_conf
-	KRB5_CONFIG=$(srcdir)/td_krb5.conf ; export KRB5_CONFIG ;\
-	$(KRB5_RUN_ENV) $(VALGRIND) ./t_std_conf  -d -s NEW.DEFAULT.REALM -d \
+	$(RUN_TEST_LOCAL_CONF) ./t_std_conf  -d -s NEW.DEFAULT.REALM -d \
 		-k IGGY.ORG -k DEFAULT_REALM.TST \
 		-D DEFAULT_REALM.TST -r bad.idea -r itar.bad.idea \
 		-r really.BAD.IDEA. -r clipper.bad.idea -r KeYEsCrOW.BaD.IDea \
@@ -223,8 +226,7 @@ check-unix-locate:: t_locate_kdc
 	if [ "$(OFFLINE)" = no ]; then \
 	    if $(DIG) $(SRVNAME) srv | grep -i $(DIGPAT) || \
 		$(NSLOOKUP) -q=srv $(SRVNAME) | grep -i $(NSPAT); then \
-		KRB5_CONFIG=$(srcdir)/td_krb5.conf ; export KRB5_CONFIG ;\
-		$(KRB5_RUN_ENV) $(VALGRIND) ./t_locate_kdc $(LOCREALM); \
+		$(RUN_TEST) ./t_locate_kdc $(LOCREALM); \
 	    else \
 		echo '*** WARNING: skipped t_locate_kdc test: known DNS name not found'; \
 	    fi; \
diff --git a/src/plugins/preauth/pkinit/Makefile.in b/src/plugins/preauth/pkinit/Makefile.in
index 743a099..6bc32af 100644
--- a/src/plugins/preauth/pkinit/Makefile.in
+++ b/src/plugins/preauth/pkinit/Makefile.in
@@ -58,7 +58,7 @@ clean::
 	$(RM) pkinit_kdf_test pkinit_kdf_test.o
 
 check-unix:: pkinit_kdf_test
-	$(RUN_SETUP) $(VALGRIND) ./pkinit_kdf_test
+	$(RUN_TEST) ./pkinit_kdf_test
 
 pkinit_kdf_test: pkinit_kdf_test.o $(STLIBOBJS) $(SHLIB_EXPDEPS)
 	$(CC_LINK) -o $@ pkinit_kdf_test.o $(STLIBOBJS) $(SHLIB_EXPLIBS)
diff --git a/src/tests/asn.1/Makefile.in b/src/tests/asn.1/Makefile.in
index 3bb3858..ac2d662 100644
--- a/src/tests/asn.1/Makefile.in
+++ b/src/tests/asn.1/Makefile.in
@@ -38,14 +38,10 @@ check:: check-encode check-encode-trval check-decode check-leak
 # Does not actually test for leaks unless using valgrind or a similar
 # tool, but does exercise a bunch of code.
 check-leak: krb5_decode_leak
-	KRB5_CONFIG=$(top_srcdir)/config-files/krb5.conf ; \
-		export KRB5_CONFIG ;\
-		$(RUN_SETUP) $(VALGRIND) ./krb5_decode_leak
+	$(RUN_TEST) ./krb5_decode_leak
 
 check-decode: krb5_decode_test
-	KRB5_CONFIG=$(top_srcdir)/config-files/krb5.conf ; \
-		export KRB5_CONFIG ;\
-		$(RUN_SETUP) $(VALGRIND) ./krb5_decode_test
+	$(RUN_TEST) ./krb5_decode_test
 
 expected_encode.out: reference_encode.out ldap_encode.out
 	if test "$(LDAP)" = yes; then \
@@ -62,15 +58,11 @@ expected_trval.out: trval_reference.out ldap_trval.out
 	fi
 
 check-encode: krb5_encode_test expected_encode.out
-	KRB5_CONFIG=$(top_srcdir)/config-files/krb5.conf ; \
-		export KRB5_CONFIG ;\
-		$(RUN_SETUP) $(VALGRIND) ./krb5_encode_test > test.out
+	$(RUN_TEST) ./krb5_encode_test > test.out
 	cmp test.out expected_encode.out
 
 check-encode-trval: krb5_encode_test expected_trval.out
-	KRB5_CONFIG=$(top_srcdir)/config-files/krb5.conf ; \
-		export KRB5_CONFIG ;\
-		$(RUN_SETUP) $(VALGRIND) ./krb5_encode_test -t > trval.out
+	$(RUN_TEST) ./krb5_encode_test -t > trval.out
 	cmp trval.out expected_trval.out
 
 install::
diff --git a/src/tests/gssapi/Makefile.in b/src/tests/gssapi/Makefile.in
index 0e309ca..7376e2b 100644
--- a/src/tests/gssapi/Makefile.in
+++ b/src/tests/gssapi/Makefile.in
@@ -18,7 +18,7 @@ all:: t_accname t_ccselect t_err t_imp_cred t_imp_name t_s4u t_namingexts \
 	t_gssexts t_spnego t_saslname t_invalid
 
 check-unix:: t_invalid
-	$(RUN_SETUP) $(VALGRIND) ./t_invalid
+	$(RUN_TEST) ./t_invalid
 
 check-pytests:: t_accname t_ccselect t_err t_imp_cred t_spnego
 	$(RUNPYTEST) $(srcdir)/t_gssapi.py $(PYTESTFLAGS)
diff --git a/src/tests/misc/Makefile.in b/src/tests/misc/Makefile.in
index 5a4b329..1e71ce6 100644
--- a/src/tests/misc/Makefile.in
+++ b/src/tests/misc/Makefile.in
@@ -17,12 +17,12 @@ SRCS=\
 all:: test_getpw
 
 check:: test_getpw test_cxx_krb5 test_cxx_gss test_cxx_rpc test_cxx_k5int test_cxx_kadm5
-	$(RUN_SETUP) $(VALGRIND) ./test_getpw
-	$(RUN_SETUP) $(VALGRIND) ./test_cxx_krb5
-	$(RUN_SETUP) $(VALGRIND) ./test_cxx_k5int
-	$(RUN_SETUP) $(VALGRIND) ./test_cxx_gss
-	$(RUN_SETUP) $(VALGRIND) ./test_cxx_rpc
-	$(RUN_SETUP) $(VALGRIND) ./test_cxx_kadm5
+	$(RUN_TEST) ./test_getpw
+	$(RUN_TEST) ./test_cxx_krb5
+	$(RUN_TEST) ./test_cxx_k5int
+	$(RUN_TEST) ./test_cxx_gss
+	$(RUN_TEST) ./test_cxx_rpc
+	$(RUN_TEST) ./test_cxx_kadm5
 
 test_getpw: $(OUTPRE)test_getpw.$(OBJEXT) $(SUPPORT_DEPLIB)
 	$(CC_LINK) $(ALL_CFLAGS) -o test_getpw $(OUTPRE)test_getpw.$(OBJEXT) $(SUPPORT_LIB)
diff --git a/src/tests/resolve/Makefile.in b/src/tests/resolve/Makefile.in
index be761c8..ec4aff6 100644
--- a/src/tests/resolve/Makefile.in
+++ b/src/tests/resolve/Makefile.in
@@ -20,9 +20,9 @@ fake-addrinfo-test: fake-addrinfo-test.o
 	$(CC_LINK) -o $@ fake-addrinfo-test.o $(SUPPORT_LIB) $(LIBS)
 
 check:: resolve addrinfo-test fake-addrinfo-test
-	$(RUN_SETUP) $(VALGRIND) ./resolve
-	$(RUN_SETUP) $(VALGRIND) ./addrinfo-test -p telnet
-	$(RUN_SETUP) $(VALGRIND) ./fake-addrinfo-test -p telnet
+	$(RUN_TEST) ./resolve
+	$(RUN_TEST) ./addrinfo-test -p telnet
+	$(RUN_TEST) ./fake-addrinfo-test -p telnet
 
 install::
 
diff --git a/src/tests/shlib/Makefile.in b/src/tests/shlib/Makefile.in
index d569cac..a57a210 100644
--- a/src/tests/shlib/Makefile.in
+++ b/src/tests/shlib/Makefile.in
@@ -13,7 +13,7 @@ SRCS=$(srcdir)/t_loader.c
 all::
 
 run-t_loader: t_loader
-	$(RUN_SETUP) $(VALGRIND) ./t_loader
+	$(RUN_TEST) ./t_loader
 
 t_loader: t_loader.o
 	$(CC_LINK) -o t_loader t_loader.o $(DL_LIB)
diff --git a/src/tests/threads/Makefile.in b/src/tests/threads/Makefile.in
index 58adde7..122e426 100644
--- a/src/tests/threads/Makefile.in
+++ b/src/tests/threads/Makefile.in
@@ -14,7 +14,7 @@ SRCS=$(srcdir)/t_rcache.c \
 all::
 
 run-t_rcache: t_rcache
-	$(RUN_SETUP) $(VALGRIND) ./t_rcache
+	$(RUN_TEST) ./t_rcache
 
 t_rcache: t_rcache.o $(KRB5_BASE_DEPLIBS)
 	$(CC_LINK) -o t_rcache t_rcache.o $(KRB5_BASE_LIBS) $(THREAD_LINKOPTS)
diff --git a/src/util/et/Makefile.in b/src/util/et/Makefile.in
index 8a5648c..50066cb 100644
--- a/src/util/et/Makefile.in
+++ b/src/util/et/Makefile.in
@@ -159,8 +159,8 @@ RUN_SETUP = @KRB5_RUN_ENV@
 # test_et doesn't have an interesting exit status, but it'll exercise
 # some cases that t_com_err doesn't, so let's see if it crashes.
 check-unix:: t_com_err test_et
-	$(RUN_SETUP) $(VALGRIND) ./test_et
-	$(RUN_SETUP) $(VALGRIND) ./t_com_err
+	$(RUN_TEST) ./test_et
+	$(RUN_TEST) ./t_com_err
 
 check-windows:: $(OUTPRE)test_et$(EXEEXT)
 	set path=$(BUILDTOP)\lib\$(OUTPRE);%path%;
diff --git a/src/util/profile/Makefile.in b/src/util/profile/Makefile.in
index 17e7cbf..a164489 100644
--- a/src/util/profile/Makefile.in
+++ b/src/util/profile/Makefile.in
@@ -147,8 +147,8 @@ clean-windows::
 	$(RM) $(PROFILE_HDR)
 
 check-unix:: test_parse test_profile test_vtable test_load modtest.conf
-	$(KRB5_RUN_ENV) $(VALGRIND) ./test_vtable
-	$(KRB5_RUN_ENV) $(VALGRIND) ./test_load
+	$(RUN_TEST) ./test_vtable
+	$(RUN_TEST) ./test_load
 
 DO_TCL=@DO_TCL@
 check-unix:: check-unix-tcl-$(DO_TCL)
@@ -160,7 +160,7 @@ check-unix-tcl-:
 
 check-unix-tcl-ok: profile_tcl
 	cp $(srcdir)/test.ini test2.ini
-	$(KRB5_RUN_ENV) $(VALGRIND) ./profile_tcl $(srcdir)/prof_test1
+	$(RUN_TEST) $(KRB5_RUN_ENV) ./profile_tcl $(srcdir)/prof_test1
 
 check-windows:: $(OUTPRE)test_profile.exe $(OUTPRE)test_parse.exe
 	$(RM) $(OUTPRE)*.obj
-- 
2.9.3

